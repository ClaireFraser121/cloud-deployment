name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [main]

jobs:
  build-and-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Check out
        uses: actions/checkout@v4

      # ðŸ”Ž Show what we are about to upload (prove contents)
      - name: Show local files (Dockerfile & requirements)
        run: |
          echo "===== LOCAL Dockerfile ====="
          sed -n '1,80p' Dockerfile
          echo "===== LOCAL requirements.txt ====="
          sed -n '1,80p' requirements.txt

      - name: Ensure remote directory exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p ~/message-server

      - name: Copy app to EC2 (repo root)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          # NOTE: no spaces in the comma list
          source: "./Dockerfile,./app.py,./requirements.txt"
          target: "~/message-server"

      # ðŸ”Ž Prove the files arrived as expected
      - name: Show remote files after upload
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "===== REMOTE Dockerfile ====="
            sed -n '1,80p' ~/message-server/Dockerfile
            echo "===== REMOTE requirements.txt ====="
            sed -n '1,80p' ~/message-server/requirements.txt

      - name: Build and run on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            cd ~/message-server
            # Force a fresh build (no cache)
            docker build --pull --no-cache -t message-server:latest .
            docker stop message-server || true
            docker rm message-server || true
            docker image prune -f || true
            docker run -d \
              --name message-server \
              --restart unless-stopped \
              -p 5002:5002 \
              -e APP_ENV=PRODUCTION \
              -e POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
              -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              -e POSTGRES_HOST=${{ secrets.POSTGRES_HOST }} \
              -e POSTGRES_DB=postgres \
              message-server:latest

            echo "===== Ports ====="
            docker ps --format 'table {{.Names}}\t{{.Command}}\t{{.Ports}}' | sed -n '1,5p'
            echo "===== Health check ====="
            curl -s -i http://127.0.0.1:5002/ | sed -n '1,8p'
